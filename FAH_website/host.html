<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rejoindre Quiz - FAH</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Host+Grotesk:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: "Host Grotesk", sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 20px; 
    }
    .container { width: 100%; max-width: 500px; }
    .card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    h1 { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 30px; color: #0d0d0d; }
    .input-group { margin-bottom: 20px; }
    label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
    input { 
      width: 100%; 
      padding: 15px; 
      border: 2px solid #e5e5e5; 
      border-radius: 10px; 
      font-family: inherit; 
      font-size: 1rem; 
      transition: all 0.3s; 
    }
    input:focus { outline: none; border-color: #667eea; }
    .btn { 
      width: 100%; 
      padding: 15px; 
      border: none; 
      border-radius: 50px; 
      background: #0d0d0d; 
      color: white; 
      font-family: inherit; 
      font-size: 1rem; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s; 
    }
    .btn:hover { background: #2d2d2d; transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .error { 
      background: #fee; 
      color: #c33; 
      padding: 12px; 
      border-radius: 8px; 
      margin-bottom: 20px; 
      text-align: center; 
    }
    .waiting-screen, .game-screen { display: none; }
    .waiting-message { 
      text-align: center; 
      font-size: 1.2rem; 
      color: #666; 
      margin: 30px 0; 
    }
    .spinner { 
      width: 50px; 
      height: 50px; 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #667eea; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      margin: 20px auto; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .question-text { 
      font-size: 1.5rem; 
      font-weight: 600; 
      text-align: center; 
      margin-bottom: 30px; 
      color: #0d0d0d; 
    }
    .timer-display { 
      text-align: center; 
      font-size: 2rem; 
      font-weight: 700; 
      color: #667eea; 
      margin-bottom: 20px; 
    }
    .timer-display.warning { color: #e74c3c; }
    .options-grid { display: grid; gap: 15px; }
    .option-btn { 
      padding: 20px; 
      border: none; 
      border-radius: 15px; 
      font-family: inherit; 
      font-size: 1.1rem; 
      font-weight: 600; 
      color: white; 
      cursor: pointer; 
      transition: all 0.3s; 
    }
    .option-btn:hover:not(:disabled) { transform: scale(1.05); }
    .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .option-btn.selected { 
      border: 4px solid white; 
      box-shadow: 0 0 20px rgba(255,255,255,0.5); 
    }
    .option-a { background: #e74c3c; }
    .option-b { background: #3498db; }
    .option-c { background: #f39c12; }
    .option-d { background: #2ecc71; }
    .result-message { 
      text-align: center; 
      padding: 30px; 
      font-size: 1.3rem; 
      font-weight: 600;
      color: #666;
    }
    .result-icon { font-size: 3rem; margin-bottom: 10px; }
    .score-display { 
      text-align: center; 
      margin: 20px 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #FBE01D 0%, #fff4a4 100%); 
      border-radius: 15px; 
    }
    .score-label { font-size: 0.9rem; color: #666; }
    .score-value { font-size: 2rem; font-weight: 700; color: #0d0d0d; }
    .final-screen { display: none; }
    .final-title { 
      font-size: 2.5rem; 
      font-weight: 700; 
      text-align: center; 
      margin-bottom: 20px; 
    }
    .final-rank { 
      text-align: center; 
      font-size: 1.5rem; 
      color: #667eea; 
      margin-bottom: 30px; 
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- JOIN SCREEN -->
      <div id="join-screen">
        <h1>üéØ Rejoindre le Quiz</h1>
        <div id="error-message" class="error" style="display:none;"></div>
        <form id="join-form">
          <div class="input-group">
            <label for="code">Code de la session</label>
            <input type="text" id="code" placeholder="123456" maxlength="6" required>
          </div>
          <div class="input-group">
            <label for="nickname">Votre pseudo</label>
            <input type="text" id="nickname" placeholder="Entrez votre pseudo" maxlength="20" required>
          </div>
          <button type="submit" class="btn" id="join-btn">Rejoindre</button>
        </form>
      </div>

      <!-- WAITING SCREEN -->
      <div id="waiting-screen" class="waiting-screen">
        <h1>‚úì Connect√© !</h1>
        <div class="waiting-message">
          Bienvenue <strong id="player-name"></strong> !<br><br>
          En attente du d√©marrage du quiz par l'h√¥te...
        </div>
        <div class="spinner"></div>
      </div>

      <!-- GAME SCREEN -->
      <div id="game-screen" class="game-screen">
        <div class="timer-display" id="timer"></div>
        <div class="question-text" id="question-text"></div>
        <div class="score-display">
          <div class="score-label">Votre score</div>
          <div class="score-value" id="score">0</div>
        </div>
        <div class="options-grid" id="options-grid"></div>
        <div id="result-message" class="result-message" style="display:none;"></div>
      </div>

      <!-- FINAL SCREEN -->
      <div id="final-screen" class="final-screen">
        <div class="final-title">üéâ Quiz termin√© !</div>
        <div class="final-rank" id="final-rank"></div>
        <div class="score-display">
          <div class="score-label">Score final</div>
          <div class="score-value" id="final-score">0</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://ckfdysasgawyixbxjyfz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZmR5c2FzZ2F3eWl4YnhqeWZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5ODg1NjcsImV4cCI6MjA3NzU2NDU2N30.t0ubaRk5sz7kewyEsOg4CpFvj47S9U1J1SP_3DQBmE8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let sessionId = null;
    let participantId = null;
    let currentScore = 0;
    let currentQuestion = null;
    let questionStartTime = null;
    let hasAnswered = false;
    let currentQuestionIndex = -1;
    let timerInterval = null;

    // Pre-fill code from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const codeParam = urlParams.get('code');
    if (codeParam) {
      document.getElementById('code').value = codeParam;
    }

    // V√©rifier si on a d√©j√† rejoint une session
    async function checkExistingParticipant() {
      const savedParticipantId = localStorage.getItem('participantId');
      const savedSessionId = localStorage.getItem('sessionId');
      
      if (savedParticipantId && savedSessionId) {
        try {
          const { data: participant } = await supabase
            .from('session_participants')
            .select('*, live_sessions(*)')
            .eq('id', savedParticipantId)
            .single();
          
          if (participant && participant.live_sessions) {
            const session = participant.live_sessions;
            
            // V√©rifier si la session n'est pas termin√©e
            if (session.status !== 'finished') {
              participantId = savedParticipantId;
              sessionId = savedSessionId;
              currentScore = participant.score;
              
              document.getElementById('player-name').textContent = participant.nickname;
              document.getElementById('score').textContent = currentScore;
              
              // Basculer vers l'√©cran appropri√©
              if (session.status === 'waiting') {
                document.getElementById('join-screen').style.display = 'none';
                document.getElementById('waiting-screen').style.display = 'block';
              } else if (session.status === 'active') {
                document.getElementById('join-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                await loadQuestion(session);
              }
              
              subscribeToSession();
              return true;
            } else {
              // Session termin√©e, nettoyer
              localStorage.removeItem('participantId');
              localStorage.removeItem('sessionId');
            }
          }
        } catch (err) {
          console.error('Error checking existing participant:', err);
          localStorage.removeItem('participantId');
          localStorage.removeItem('sessionId');
        }
      }
      return false;
    }

    checkExistingParticipant();

    document.getElementById('join-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await joinSession();
    });

    async function joinSession() {
      const code = document.getElementById('code').value.trim();
      const nickname = document.getElementById('nickname').value.trim();
      const errorEl = document.getElementById('error-message');

      if (!code || !nickname) {
        showError('Veuillez remplir tous les champs');
        return;
      }

      try {
        // Find session by code
        const { data: session, error: sessionError } = await supabase
          .from('live_sessions')
          .select('*')
          .eq('code', code)
          .single();

        if (sessionError || !session) {
          showError('Code de session invalide');
          return;
        }

        if (session.status === 'finished') {
          showError('Cette session est termin√©e');
          return;
        }

        // V√©rifier si la session a expir√© (plus d'une heure)
        const sessionCreatedAt = new Date(session.created_at).getTime();
        const oneHourAgo = Date.now() - (60 * 60 * 1000);
        
        if (sessionCreatedAt < oneHourAgo) {
          showError('Cette session a expir√© (plus d\'une heure)');
          return;
        }

        sessionId = session.id;

        // Check if nickname is already taken in this session
        const { data: existingParticipants } = await supabase
          .from('session_participants')
          .select('nickname')
          .eq('session_id', sessionId)
          .eq('nickname', nickname);

        if (existingParticipants && existingParticipants.length > 0) {
          showError('Ce pseudo est d√©j√† pris dans cette session');
          return;
        }

        // Join session
        const { data: participant, error: joinError } = await supabase
          .from('session_participants')
          .insert([{
            session_id: sessionId,
            nickname: nickname,
            score: 0
          }])
          .select()
          .single();

        if (joinError) throw joinError;

        participantId = participant.id;
        
        // Sauvegarder dans localStorage
        localStorage.setItem('participantId', participantId);
        localStorage.setItem('sessionId', sessionId);
        
        document.getElementById('player-name').textContent = nickname;

        // Switch to waiting screen
        document.getElementById('join-screen').style.display = 'none';
        document.getElementById('waiting-screen').style.display = 'block';

        // Subscribe to session updates
        subscribeToSession();

      } catch (err) {
        console.error('Join error:', err);
        showError('Erreur lors de la connexion: ' + err.message);
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    function subscribeToSession() {
      supabase
        .channel('session-updates')
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'live_sessions',
          filter: `id=eq.${sessionId}`
        }, async (payload) => {
          const session = payload.new;
          
          if (session.status === 'active' && session.current_question_index >= 0) {
            await loadQuestion(session);
          } else if (session.status === 'finished') {
            await showFinalScreen();
          }
        })
        .subscribe();
      
      // S'abonner aux mises √† jour du score
      supabase
        .channel('participant-updates')
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'session_participants',
          filter: `id=eq.${participantId}`
        }, (payload) => {
          const participant = payload.new;
          currentScore = participant.score;
          document.getElementById('score').textContent = currentScore;
        })
        .subscribe();
    }

    async function loadQuestion(session) {
      // Si c'est la m√™me question et qu'on a d√©j√† r√©pondu, ne rien faire
      if (session.current_question_index === currentQuestionIndex && hasAnswered) {
        return;
      }
      
      // Si c'est une nouvelle question
      if (session.current_question_index !== currentQuestionIndex) {
        hasAnswered = false;
        currentQuestionIndex = session.current_question_index;
      }
      
      // Get quiz data
      const { data: quiz } = await supabase
        .from('quizzes')
        .select('questions')
        .eq('id', session.quiz_id)
        .single();

      const questions = typeof quiz.questions === 'string' ? JSON.parse(quiz.questions) : quiz.questions;
      currentQuestion = questions[session.current_question_index];
      currentQuestion.index = session.current_question_index;

      // Utiliser le temps de d√©marrage du serveur pour synchroniser
      questionStartTime = new Date(session.question_start_time).getTime();

      // Switch to game screen
      document.getElementById('waiting-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      document.getElementById('result-message').style.display = 'none';

      // Display question
      document.getElementById('question-text').textContent = currentQuestion.question;

      // V√©rifier si on a d√©j√† r√©pondu √† cette question
      const { data: existingAnswer } = await supabase
        .from('participant_answers')
        .select('*')
        .eq('participant_id', participantId)
        .eq('question_index', currentQuestionIndex)
        .single();

      if (existingAnswer) {
        hasAnswered = true;
        displayOptionsAfterAnswer(existingAnswer.answer_index);
        showResultMessage();
      } else {
        // Display options
        const optionsGrid = document.getElementById('options-grid');
        optionsGrid.innerHTML = '';
        
        const colors = ['option-a', 'option-b', 'option-c', 'option-d'];
        currentQuestion.options.forEach((opt, i) => {
          const btn = document.createElement('button');
          btn.className = `option-btn ${colors[i]}`;
          btn.textContent = opt;
          btn.addEventListener('click', () => selectAnswer(i));
          optionsGrid.appendChild(btn);
        });

        // Calculer le temps restant bas√© sur le temps serveur
        const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
        const remaining = Math.max(0, (currentQuestion.timeLimit || 30) - elapsed);
        
        startTimer(remaining);
      }
    }

    function displayOptionsAfterAnswer(selectedIndex) {
      const optionsGrid = document.getElementById('options-grid');
      optionsGrid.innerHTML = '';
      
      const colors = ['option-a', 'option-b', 'option-c', 'option-d'];
      currentQuestion.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = `option-btn ${colors[i]}`;
        if (i === selectedIndex) {
          btn.classList.add('selected');
        }
        btn.textContent = opt;
        btn.disabled = true;
        optionsGrid.appendChild(btn);
      });
    }

    function startTimer(seconds) {
      let timeLeft = seconds;
      const timerEl = document.getElementById('timer');
      timerEl.textContent = `‚è±Ô∏è ${timeLeft}s`;
      timerEl.classList.remove('warning');

      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = `‚è±Ô∏è ${timeLeft}s`;

        if (timeLeft <= 5) {
          timerEl.classList.add('warning');
        }

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (!hasAnswered) {
            disableOptions();
            showResultMessage();
          }
        }
      }, 1000);
    }

    async function selectAnswer(answerIndex) {
      if (hasAnswered) return;
      hasAnswered = true;

      const responseTime = Date.now() - questionStartTime;

      // Visual feedback
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach((btn, i) => {
        if (i === answerIndex) {
          btn.classList.add('selected');
        }
        btn.disabled = true;
      });

      // Submit answer
      try {
        await supabase
          .from('participant_answers')
          .insert([{
            session_id: sessionId,
            participant_id: participantId,
            question_index: currentQuestionIndex,
            answer_index: answerIndex,
            response_time: responseTime
          }]);

        // Show result (sans dire si c'est correct ou non)
        showResultMessage();

      } catch (err) {
        console.error('Error submitting answer:', err);
      }
    }

    function disableOptions() {
      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.disabled = true;
      });
    }

    function showResultMessage() {
      const resultEl = document.getElementById('result-message');
      resultEl.innerHTML = '<div class="result-icon">‚è≥</div><div>En attente des r√©sultats...</div>';
      resultEl.style.display = 'block';
    }

    async function showFinalScreen() {
      clearInterval(timerInterval);
      
      // Get final score and rank
      const { data: participant } = await supabase
        .from('session_participants')
        .select('score')
        .eq('id', participantId)
        .single();

      const { data: allParticipants } = await supabase
        .from('session_participants')
        .select('score')
        .eq('session_id', sessionId)
        .order('score', { ascending: false });

      const rank = allParticipants.findIndex(p => p.score === participant.score) + 1;

      document.getElementById('game-screen').style.display = 'none';
      document.getElementById('final-screen').style.display = 'block';
      document.getElementById('final-rank').textContent = `Vous √™tes #${rank} sur ${allParticipants.length}`;
      document.getElementById('final-score').textContent = participant.score;
      
      // Nettoyer le localStorage
      localStorage.removeItem('participantId');
      localStorage.removeItem('sessionId');
    }
  </script>
</body>
</html>
