<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Rejoindre Quiz - FAH</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Host+Grotesk:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
  <style>
    /* CSS conserv√© de l'original ‚Äî inchang√© sauf style mineur */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Host Grotesk",sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .container{width:100%;max-width:500px}
    .card{background:white;border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    h1{font-size:2rem;font-weight:700;text-align:center;margin-bottom:30px;color:#0d0d0d}
    .input-group{margin-bottom:20px}
    label{display:block;font-weight:600;margin-bottom:8px;color:#333}
    input{width:100%;padding:15px;border:2px solid #e5e5e5;border-radius:10px;font-family:inherit;font-size:1rem;transition:all .3s}
    input:focus{outline:none;border-color:#667eea}
    .btn{width:100%;padding:15px;border:none;border-radius:50px;background:#0d0d0d;color:white;font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s}
    .btn:hover{background:#2d2d2d;transform:translateY(-2px)}
    .error{background:#fee;color:#c33;padding:12px;border-radius:8px;margin-bottom:20px;text-align:center}
    .waiting-screen,.game-screen{display:none}
    .waiting-message{text-align:center;font-size:1.2rem;color:#666;margin:30px 0}
    .spinner{width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .question-text{font-size:1.5rem;font-weight:600;text-align:center;margin-bottom:30px;color:#0d0d0d}
    .timer-display{text-align:center;font-size:2rem;font-weight:700;color:#667eea;margin-bottom:20px}
    .timer-display.warning{color:#e74c3c}
    .options-grid{display:grid;gap:15px}
    .option-btn{padding:20px;border:none;border-radius:15px;font-family:inherit;font-size:1.1rem;font-weight:600;color:white;cursor:pointer;transition:all .3s}
    .option-btn:hover:not(:disabled){transform:scale(1.05)}
    .option-btn:disabled{opacity:.7;cursor:not-allowed}
    .option-btn.selected{border:4px solid white;box-shadow:0 0 20px rgba(255,255,255,.5)}
    .option-a{background:#e74c3c}
    .option-b{background:#3498db}
    .option-c{background:#f39c12}
    .option-d{background:#2ecc71}
    .result-message{text-align:center;padding:30px;font-size:1.3rem;font-weight:600}
    .result-correct{color:#2ecc71}
    .result-wrong{color:#e74c3c}
    .result-icon{font-size:3rem;margin-bottom:10px}
    .score-display{text-align:center;margin:20px 0;padding:20px;background:linear-gradient(135deg,#FBE01D 0%,#fff4a4 100%);border-radius:15px}
    .score-label{font-size:0.9rem;color:#666}
    .score-value{font-size:2rem;font-weight:700;color:#0d0d0d}
    .final-screen{display:none}
    .final-title{font-size:2.5rem;font-weight:700;text-align:center;margin-bottom:20px}
    .final-rank{text-align:center;font-size:1.5rem;color:#667eea;margin-bottom:30px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- JOIN -->
      <div id="join-screen">
        <h1>üéØ Rejoindre le Quiz</h1>
        <div id="error-message" class="error" style="display:none;"></div>
        <form id="join-form">
          <div class="input-group">
            <label for="code">Code de la session</label>
            <input type="text" id="code" placeholder="123456" maxlength="6" required>
          </div>
          <div class="input-group">
            <label for="nickname">Votre pseudo</label>
            <input type="text" id="nickname" placeholder="Entrez votre pseudo" maxlength="20" required>
          </div>
          <button type="submit" class="btn" id="join-btn">Rejoindre</button>
        </form>
      </div>

      <!-- WAITING -->
      <div id="waiting-screen" class="waiting-screen">
        <h1>‚úì Connect√© !</h1>
        <div class="waiting-message">
          Bienvenue <strong id="player-name"></strong> !<br><br>
          En attente du d√©marrage du quiz par l'h√¥te...
        </div>
        <div class="spinner"></div>
      </div>

      <!-- GAME -->
      <div id="game-screen" class="game-screen">
        <div class="timer-display" id="timer">‚è±Ô∏è 0s</div>
        <div class="question-text" id="question-text"></div>

        <div class="score-display">
          <div class="score-label">Votre score</div>
          <div class="score-value" id="score">0</div>
        </div>

        <div class="options-grid" id="options-grid"></div>

        <div id="result-message" class="result-message" style="display:none;">En attente de la r√©ponse...</div>
      </div>

      <!-- FINAL -->
      <div id="final-screen" class="final-screen">
        <div class="final-title">üéâ Quiz termin√© !</div>
        <div class="final-rank" id="final-rank"></div>
        <div class="score-display">
          <div class="score-label">Score final</div>
          <div class="score-value" id="final-score">0</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://ckfdysasgawyixbxjyfz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZmR5c2FzZ2F3eWl4YnhqeWZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5ODg1NjcsImV4cCI6MjA3NzU2NDU2N30.t0ubaRk5sz7kewyEsOg4CpFvj47S9U1J1SP_3DQBmE8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let sessionId = null;
    let participantId = null;
    let currentQuestion = null;
    let questionStartTime = null; // timestamp from server (ms)
    let hasAnswered = false;
    let localScore = 0;

    // prefill code from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const codeParam = urlParams.get('code');
    if (codeParam) document.getElementById('code').value = codeParam;

    document.getElementById('join-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await joinSession();
    });

    async function joinSession() {
      const code = document.getElementById('code').value.trim();
      const nickname = document.getElementById('nickname').value.trim();
      if (!code || !nickname) {
        showError('Veuillez remplir tous les champs');
        return;
      }

      try {
        // find session by code
        const { data: session, error: sessionError } = await supabase
          .from('live_sessions')
          .select('*')
          .eq('code', code)
          .single();
        if (sessionError || !session) {
          showError('Code de session invalide');
          return;
        }
        if (session.status === 'finished') {
          showError('Cette session est termin√©e');
          return;
        }
        sessionId = session.id;

        // nickname unique check
        const { data: existing } = await supabase
          .from('session_participants')
          .select('nickname')
          .eq('session_id', sessionId)
          .eq('nickname', nickname);

        if (existing && existing.length > 0) {
          showError('Ce pseudo est d√©j√† pris dans cette session');
          return;
        }

        // insert participant
        const { data: participant, error: joinError } = await supabase
          .from('session_participants')
          .insert([{ session_id: sessionId, nickname, score: 0 }])
          .select()
          .single();

        if (joinError) throw joinError;
        participantId = participant.id;
        localScore = participant.score || 0;
        document.getElementById('player-name').textContent = nickname;

        // show waiting
        document.getElementById('join-screen').style.display = 'none';
        document.getElementById('waiting-screen').style.display = 'block';

        subscribeToSession();
        subscribeToParticipantUpdates();

      } catch (err) {
        console.error('Join error:', err);
        showError('Erreur lors de la connexion: ' + (err.message || err));
      }
    }

    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    // subscribe to live_sessions updates
    function subscribeToSession() {
      supabase
        .channel('session-updates-'+Math.random())
        .on('postgres_changes', {
          event: 'UPDATE', schema: 'public', table: 'live_sessions',
          filter: `id=eq.${sessionId}`
        }, async (payload) => {
          const session = payload.new;

          if (session.status === 'active' && session.current_question_index >= 0) {
            // load question & compute remaining from server question_start_time
            await loadQuestion(session);
          } else if (session.status === 'finished') {
            await showFinalScreen();
          }
        })
        .subscribe();
    }

    // subscribe to participant row updates to get authoritative score updates
    function subscribeToParticipantUpdates() {
      supabase
        .channel('participant-'+sessionId+'-'+participantId)
        .on('postgres_changes', {
          event: 'UPDATE', schema: 'public', table: 'session_participants',
          filter: `id=eq.${participantId}`
        }, payload => {
          const p = payload.new;
          localScore = p.score || localScore;
          document.getElementById('score').textContent = localScore;
        })
        .subscribe();
    }

    // load question using session info from DB (authoritative start time)
    async function loadQuestion(session) {
      hasAnswered = false;
      // fetch quiz questions
      const { data: quiz } = await supabase
        .from('quizzes')
        .select('questions')
        .eq('id', session.quiz_id)
        .single();
      const questions = typeof quiz.questions === 'string' ? JSON.parse(quiz.questions) : quiz.questions;
      currentQuestion = questions[session.current_question_index];
      // server authoritative start time -> compute remaining relative to client clock
      questionStartTime = new Date(session.question_start_time).getTime();

      // show game UI
      document.getElementById('waiting-screen').style.display = 'none';
      document.getElementById('final-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      document.getElementById('result-message').style.display = 'none';

      document.getElementById('question-text').textContent = currentQuestion.question;

      // render options
      const optionsGrid = document.getElementById('options-grid');
      optionsGrid.innerHTML = '';
      const colors = ['option-a','option-b','option-c','option-d'];
      currentQuestion.options.forEach((opt,i) => {
        const btn = document.createElement('button');
        btn.className = `option-btn ${colors[i]}`;
        btn.textContent = opt;
        btn.disabled = false;
        btn.addEventListener('click', () => selectAnswer(i));
        optionsGrid.appendChild(btn);
      });

      // start timer using server start time: remaining = timeLimit - elapsed
      startTimerWithServerTime(currentQuestion.timeLimit || 30, questionStartTime);
    }

    // Timer using server's question_start_time (keeps all clients in sync)
    function startTimerWithServerTime(totalSeconds, serverStartMs) {
      const timerEl = document.getElementById('timer');
      clearInterval(window._playerTimerInterval);

      function updateOnce() {
        const elapsedSec = Math.floor((Date.now() - serverStartMs) / 1000);
        let remaining = totalSeconds - elapsedSec;
        if (remaining < 0) remaining = 0;
        timerEl.textContent = `‚è±Ô∏è ${remaining}s`;
        timerEl.classList.toggle('warning', remaining <= 5);
        if (remaining === 0) {
          clearInterval(window._playerTimerInterval);
          // if player hasn't answered, disable options and show waiting result
          if (!hasAnswered) {
            disableOptions();
            showWaitingMessage();
          }
        }
      }

      // initial update then interval
      updateOnce();
      window._playerTimerInterval = setInterval(updateOnce, 500);
    }

    // select answer: prevent duplicates by checking existing answer first
    async function selectAnswer(answerIndex) {
      if (hasAnswered || !participantId || !sessionId || !currentQuestion) return;
      hasAnswered = true;

      // visual immediate feedback: mark selected and disable
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach((btn,i) => {
        if (i === answerIndex) btn.classList.add('selected');
        btn.disabled = true;
      });

      // compute response time relative to server start time
      const responseTimeMs = Math.max(0, Date.now() - (questionStartTime || Date.now()));

      try {
        // Check if there's already an answer for this participant & question -> if none, insert; if exists, ignore
        const { data: existing } = await supabase
          .from('participant_answers')
          .select('*')
          .eq('session_id', sessionId)
          .eq('participant_id', participantId)
          .eq('question_index', currentQuestion.index || 0);

        if (existing && existing.length > 0) {
          // already answered (ignore duplicate attempt)
          console.warn('Answer already exists for participant/question ‚Äî ignoring duplicate submit.');
        } else {
          // insert answer (server/host will compute correctness & award points)
          await supabase
            .from('participant_answers')
            .insert([{
              session_id: sessionId,
              participant_id: participantId,
              question_index: currentQuestion.index || 0,
              answer_index: answerIndex,
              response_time: responseTimeMs
            }]);
        }

        // Show "waiting" instead of revealing correct/wrong
        showWaitingMessage();

      } catch (err) {
        console.error('Error submitting answer:', err);
      }
    }

    function disableOptions() {
      document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
    }

    // Show waiting message (player doesn't get correct/wrong)
    function showWaitingMessage() {
      const el = document.getElementById('result-message');
      el.style.display = 'block';
      el.textContent = 'En attente de la r√©ponse...';
    }

    // Final screen: fetch authoritative score & rank
    async function showFinalScreen() {
      // get final participant row
      const { data: participant } = await supabase
        .from('session_participants')
        .select('score')
        .eq('id', participantId)
        .single();

      const { data: allParticipants } = await supabase
        .from('session_participants')
        .select('score')
        .eq('session_id', sessionId)
        .order('score', { ascending: false });

      const rank = allParticipants.findIndex(p => p.score === participant.score) + 1;

      document.getElementById('game-screen').style.display = 'none';
      document.getElementById('final-screen').style.display = 'block';
      document.getElementById('final-rank').textContent = `Vous √™tes #${rank} sur ${allParticipants.length}`;
      document.getElementById('final-score').textContent = participant.score || 0;
    }
  </script>
</body>
</html>
